extends layout

block append head
	link(rel='stylesheet', href='/stylesheets/basic.css')
	script(src='/js/filedrop.js')
	script(src='/js/jquery.js')
		
block content

	div.container-top
		h1= title
		
		p 
			b Welcome 
			| 
			i to 
			u #{title}
		
	div.container-center
		div.sheets
			div.sheet
				input(type="radio" id="sheet-1" name="sheet-group" checked)
				label(for="sheet-1") Sheet 1
				
				div.data
					table
						- for (var t = 0; t < 21; t++)
							if t==0
								th(id="r"+t)
									- for ( var c = 65; c < 91; c++)
										th(id="_"+t)= String.fromCharCode(c)
							else
								tr(id="r"+t)
									- for ( var c = 64; c < 91; c++)
										if c==64
											th(id="_"+t)= t
												
										else
											td(id=String.fromCharCode(c)+t)						

	div.container-right
		form#xlUpload(enctype   =  "multipart/form-data" action="/xlUpload" method="POST")
			input(type="file" name="fileUpload")
			input(type="submit" name="submit" value="Upload")
			
	script(src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js")
	script(src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js")
	
	script.
		$(document).ready(function() {

		$('#xlUpload').submit(function() {
		
		        $(this).ajaxSubmit({
		
		            error: function(xhr) {
				            status('Error: ' + xhr.status);
		            },
					contentType: "application/json",
					dataType: 'json',
		            success: function(xl) {
					//		console.log(JSON.stringify(xl.sheets));
		         			
							$.each(xl.sheets, function(c, v){
					//			console.log( c + " : " + v)
								var s = c; // Sheet name
								
								var sheet = $("<div/>", {
									'class': 'sheet'
								}).appendTo('.sheets');

								$("<input/>",{
									type: 'radio',
									id: s,
									name: 'sheet-group'
								}).appendTo(sheet);
								
								$("<label/>", {
									for: s,
									text: s
								}).appendTo(sheet);
								
								var table = $("<table/>").appendTo(sheet);
								var defaultRowCount = 50;
								var defaultColRange = 92;
								
								if (v['!ref'] != undefined){
								  var range = v['!ref'].split(':')[1].match(/(\d+|[^\d]+)/g).join('|').split('|');
								  defaultRowCount = range[1] > defaultRowCount ? range[1] : defaultRowCount
								  
								  if(range[0].length == 2 ){
								    defaultColRange += ( (range[0].charCodeAt(0) - 64 ) * 26) + (range[0].charCodeAt(1) - 64 );  
								  }
								}
								
					//			console.log(range+":: "+range[0].charCodeAt(0)+" & "+range[0].length+" :: defaultColRange ="+ defaultColRange);
								
								//Iterating through JSON map
								$.each(v, function(l, t){
					//				console.log( l + " - "+t )
									if ( l !== "!ref")
										$("#"+l).html(t)
								}); 
							});	
		            }
			});
			
			return false;
		    });
		});


	//
		fieldset#xlDrop.fd-zone
			p.legend Drop a file or <em>Browse</em>
			p.progress
				span#progress-bar
	
		script.
			
			// We can deal with iframe uploads using this URL:
			var options = {iframe: {url: '/xlUpload'}};
			
			// 'zone' is an ID but you can also give a DOM node:
			var zone = new FileDrop('xlDrop', options);
			
			// Do something when a user chooses or drops a file:
			zone.event('send', function (files) {
			 	
			  // FileList might contain multiple items.
			  files.each(function (file) {
					
			  	// Reset the progress when a new upload starts:
			    file.event('sendXHR', function () {
			      fd.byID('progress-bar').style.width = 0
			    })
			
			    // Update progress when browser reports it:
			    file.event('progress', function (current, total) {
			      var width = current / total * 100 + '%'
			      fd.byID('progress-bar').style.width = width
			    })	
	
			  	// React on successful AJAX upload:
			    file.event('done', function (xhr) {
			      // Here, 'this' points to fd.File instance.
			      alert(xhr.responseText)
			    })
				
				file.event('error', function (e, xhr) {
			      
			      if (xhr.readyState == 4 && !xhr.status) {
			        alert('Timeout reached, request aborted.')
			      } else {
			        alert(xhr.status + ', ' + xhr.statusText)
			      }
			    })	
			
			
			    // Send the file:
			    file.sendTo('/xlUpload');
			
			  });
			});	